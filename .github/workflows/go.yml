name: Go CI/CD

on:
  push:
    branches:
      - master
      - cr_automation
  pull_request:
    branches:
      - master

jobs:
  build_and_test:
    runs-on: ubuntu-latest
    steps:
      # Checkout the repository
      - uses: actions/checkout@v4

      # Set up Go
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'

      # Get dependencies
      - name: Get dependencies
        run: go mod tidy

      # Build the Go application
      - name: Build
        run: go build -v ./...

      # Test the Go application
      - name: Test
        run: go test -v ./...

  push_image:
    runs-on: ubuntu-latest
    needs: build_and_test
    steps:
      # Checkout the repository
      - uses: actions/checkout@v4

      # Log in to IBM Cloud
     # - name: Log in to IBM Cloud
     #   env:
     #     IBM_CLOUD_API_KEY: ${{ secrets.IBM_CLOUD_API_KEY }}
     #   run: |
     #     ibmcloud login --apikey $IBM_CLOUD_API_KEY --no-region
     #     ibmcloud target -r us-south

      # Install IBM Cloud CLI and Container Registry CLI
      - name: Install IBM Cloud CLI
        run: |
          curl -fsSL https://clis.cloud.ibm.com/install/linux | sh
          ibmcloud plugin install container-registry -f

      # Build the Docker image
     # - name: Build Docker image
     #   run: docker build -t myapp:latest .

      # Tag the Docker image for IBM Cloud
     # - name: Tag Docker image
     #   run: docker tag myapp:latest us.icr.io/my-namespace/myapp:latest

      # Push the Docker image to IBM Cloud Container Registry
      #- name: Push Docker image
      #  env:
       #   IBM_CLOUD_API_KEY: ${{ secrets.IBM_CLOUD_API_KEY }}
       # run: |
        #  ibmcloud login --apikey $IBM_CLOUD_API_KEY --no-region
        #  ibmcloud cr login
        #  docker push us.icr.io/my-namespace/myapp:latest
